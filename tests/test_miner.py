import json

from cveminer import miner

class TestMiner(object):

    class DummyArgs(object):
        def __init__(self, online, local = None, password=None, apikey=None, store_db = False):
            self.online = online
            self.local = local
            self.password = password
            self.apikey = apikey
            self.store_db = store_db

    def test_mine_repo(self):
        args = self.DummyArgs('wrongInput', 'alsoWrongInput')

        assert miner.mine_repo(args) == dict()
        args.online = 'https://github.com/MBalazs8796/testing'
        # I assume that git log parser works correctly, so no in depth check is needed here
        assert len(miner.mine_repo(args)) == 7
        args.online = None
        assert miner.mine_repo(args) == dict()
        args.local = './repos/testing'
        assert len(miner.mine_repo(args)) == 7

    def test_date_parser(self):
        assert str(miner.dateParser('2020-11-12 12:59:37+01:00')) == '2020-11-12 12:59:37+01:00'
        assert miner.dateParser('20202.3/a') == None

    def test_get_stats(self):
        args = self.DummyArgs('https://github.com/MBalazs8796/testing')
        miner.get_stats(args)
        with open('stats.json', 'r', encoding='utf-8') as f:
            with open('./tests/correct_result.json', 'r', encoding='utf-8') as correct_f:
                assert json.load(f) == json.load(correct_f)
